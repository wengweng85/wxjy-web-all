
<!DOCTYPE html>
<html>
<head>
<title>小额贷记帐本</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=yes">
<meta name="description" content="">
<link rel="stylesheet" href="https://app.accounting.yuyaoit.cn/themes/jqweui/lib/weui.min.css?2018-10-17">
<link rel="stylesheet" href="https://app.accounting.yuyaoit.cn/themes/jqweui/css/jquery-weui.min.css">
<style>
body, html {height: 100%;-webkit-tap-highlight-color: transparent;}
.acc-title {text-align: center;font-size: 24px;color: #3cc51f;font-weight: 400;margin: 0 15%;}
.acc-sub-title {text-align: center;color: #888;font-size: 14px;}
.acc-header {padding: 15px 0;}
.acc-content-padded {padding: 15px;}
.acc-second-title {text-align: center;font-size: 24px;color: #3cc51f;font-weight: 400;margin: 0 15%;}
.red {color:red;}
.green{color:green;}
footer {text-align: center;font-size: 14px;padding: 20px;}
footer a {color: #999;text-decoration: none;}
.weui-tab__bd .weui-tab__bd-item{top:2.2rem;height:90%;}
#borrow_div,#tipssms_div,#tipssmsusers_div,#recharge_div{z-index:503;}
#lendingList .prog-tips{margin:0 5px 0 5px;font-size:14px;color:#999;}
#lendingList .lend_current:before{border-top:1px solid #fff;}
#lendingList .lend_history:before{border-top:1px solid #fff;}
#index_div .weui-grid__icon{width:60px;height:60px;margin:0 auto;}
#nav_bottom .weui-tabbar__label{font-size:12px;}
.page__title{margin:.77em;font-weight: bold;}
.page__bd{background:rgba(255,255,255,0.8);}
.weui-cells__title{margin-top:0em;margin-bottom:0em;padding:5px 0 5px 15px;}
.weui-cells {margin-top:0em;font-size:16px;}
.weui-cells__title{font-size:16px;background-color: #efeff4;}
#userList .weui-cell__hd{width:30px;margin-right:10px;}
#userList .weui-cell__hd img{width:100%;}
.badge-tip{position: relative;top: -6.8em;right: -3.8em;display:none;}
#accountlist_div .list-btn{height:30px;margin:8px 5px 0 0;}
#accountlist_div .weui-flex__item{padding-left:8px;}
#upgrade_div .weui-media-box__desc{height:auto;overflow:visible;}
#accounttotal_div .weui-form-preview__item span{font-size:16px;}
#borrowlist_div .list-btn,#severlist_div .list-btn{height:30px;margin:5px 5px 0 0;}
.weui-cell{padding-left:5px;}
#user_div .sub-title{float:right;margin-right:5px;color:blue;}
</style>
</head>
	<body ontouchstart>
		<div class="weui-tab">
			<div class="weui-tab__bd">
<div id="index_div" class="weui-tab__bd-item weui-tab__bd-item--active">
		<header class='acc-header'>
			<h2 class="acc-title">小额贷记帐本-导航</h2>
		</header>
		<div class="weui-grids">
			<a class="weui-grid js_grid" href="javascript:initLendingForm();">
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/1.png" alt=""></div>
			<p class="weui-grid__label">放贷记录</p>
			</a>
			<a class="weui-grid js_grid" href="javascript:toLendingList();">
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/6.png" alt=""></div>
			<p class="weui-grid__label">查看放贷</p>
			</a>
			<a class="weui-grid js_grid" href="javascript:toLendingHistoryList();">
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/10.png" alt=""></div>
			<p class="weui-grid__label">历史放贷</p>
			</a>
			<a class="weui-grid js_grid" href="javascript:toIncomeDiv('nearly');">
			<div class="weui-grid__icon">
			<img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/12.png" alt="">
			<span class="weui-badge badge-tip" id="badgetips_nearly">0</span>
			</div>
			<p class="weui-grid__label">收款提醒</p>
			</a>
			<a class="weui-grid js_grid" href="javascript:toIncomeDiv('overdue');">
			<div class="weui-grid__icon">
			<img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/23.png" alt="">
			<span class="weui-badge badge-tip" id="badgetips_overdue">0</span>
			</div>
			<p class="weui-grid__label">逾期收款</p>
			</a>
			<a class="weui-grid js_grid" href="javascript:toCountDiv()" >
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/3.png" alt="">
			</div>
			<p class="weui-grid__label">营收统计</p>
			</a>
			<!--
			<a class="weui-grid js_grid" href="javascript:quickUserAdd();">
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/14.png" alt=""></div>
			<p class="weui-grid__label">新增客户</p>
			</a>-->
			<a class="weui-grid js_grid" href="javascript:quickUserList();">
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/7.png" alt=""></div>
			<p class="weui-grid__label">客户管理</p>
			</a>
			<a class="weui-grid js_grid" href="javascript:toCreditLog();">
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/18.png" alt=""></div>
			<p class="weui-grid__label">征信日志</p>
			</a>
			<a class="weui-grid js_grid" href="javascript:quickBussLend();">
			<div class="weui-grid__icon"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/5.png" alt=""><span class="weui-badge" style="position: relative;top: -6.8em;right: -2.8em;">New</span></div>
			<p class="weui-grid__label">服务商名录</p>
			</a>
		</div>
<!--end;-->
</div>
<div id="lending_div" class="weui-tab__bd-item">
<!--放贷列表 begin:-->
<div class="weui-cells__title">我的放贷记录</div>
<div class="weui-cells" id="lendingList" style="display:none;"></div>
<!--放贷列表 end;-->

<!--放贷表单 begin:-->
<form id="formlending" onsubmit="return false;">
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell weui-cell_vcode">
				<div class="weui-cell__hd">
					<label class="weui-label">贷款人</label>
				</div>
				<div class="weui-cell__bd">
					<input class="weui-input" name="name" type="text" placeholder="贷款人姓名" pattern="^[\u4e00-\u9fa5]{1,7}$|^[\dA-Za-z_]{1,14}$">
				</div>
				<div class="weui-cell__ft">
					<button class="weui-vcode-btn" id="customerSelect">选择老客户</button>
				</div>
			</div>
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">联系电话</label></div>
				<div class="weui-cell__bd">
					<input class="weui-input" type="tel" name="phone"  maxlength="11"  placeholder="请输入借款人手机号码">
				</div>
			</div>
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">放贷金额</label></div>
				<div class="weui-cell__bd">
					<input class="weui-input" name="money" type="number" pattern="[0-9]{4,7}" maxlength="7"  placeholder="放贷金额" min="100" max="1000000"  value="1000" onchange="calculationIncomeItem()">
				</div>
			</div>
			<div class="weui-cell weui-cell_vcode">
				<div class="weui-cell__hd">
					<label class="weui-label">放贷利息</label>
				</div>
				<div class="weui-cell__bd">
					<input class="weui-input" name="rate" type="number" pattern="[0-9]*" maxlength="4" placeholder="请输入放贷利息" step="0.01" onchange="calculationIncomeItem()">
				</div>
				<div class="weui-cell__ft">
					<button class="weui-vcode-btn" id="rate_set">% (月息)</button>
					<input name="rate_unit" type="hidden" id="rate_unit" value="30">
				</div>
			</div>
			<div class="weui-cell" id="calculationItemShow"></div>
			<div class="weui-cell">
				<div class="weui-cell__hd"><label for="" class="weui-label">放贷日期</label></div>
				<div class="weui-cell__bd">
					<input class="weui-input" id="beginday" name="beginday" type="date" value="2019-03-25">
				</div>
			</div>
			<div class="weui-cells__title">收款方式</div>
			<div class="weui-cells weui-cells_radio">
			  <label class="weui-cell weui-check__label" for="x12">
				<div class="weui-cell__bd">
				  <p>先息后本</p>
				</div>
				<div class="weui-cell__ft">
				  <input type="radio" name="income_type" class="weui-check" id="x12" value="2" checked="checked">
				  <span class="weui-icon-checked"></span>
				</div>
			  </label>
			  <label class="weui-cell weui-check__label" for="x11">
				<div class="weui-cell__bd">
				  <p>等额本息</p>
				</div>
				<div class="weui-cell__ft">
				  <input type="radio" class="weui-check" name="income_type" id="x11" value="1">
				  <span class="weui-icon-checked"></span>
				</div>
			  </label>
			</div>
			<div class="weui-cell weui-cell_vcode">
				<div class="weui-cell__hd">
					<label class="weui-label">收款分期</label>
				</div>
				<div class="weui-cell__bd">
					<input class="weui-input" type="number" name="stage" value="6" maxlength="2" pattern="[0-9]{1,2}" min="1" max="99" step="1" placeholder="请输入收款分期数" onchange="calculationIncomeItem()">
				</div>
				<div class="weui-cell__ft">
					<button class="weui-vcode-btn" id="stage_set" style="font-size:14px;">期,1周为1期</button>
					<input name="stage_unit" type="hidden" id="stage_unit" value="7">
					</div>
			</div>
			<div class="weui-cell" id="calculationStageShow"></div>
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">服务费</label></div>
				<div class="weui-cell__bd">
					<input class="weui-input" type="number" name="fee" value="" pattern="[0-9]*" maxlength="5"  placeholder="请输入收取的服务费">
				</div>
			</div>
			<div class="weui-cells__title">备注说明</div>
			<div class="weui-cells weui-cells_form">
				<div class="weui-cell">
				<div class="weui-cell__bd">
				  <textarea class="weui-textarea" name="bak" placeholder="请输入备注说明" rows="4" maxlength="80" ></textarea>
				</div>
				</div>
			</div>
		</div>
		<div class="weui-btn-area">
			<a href="javascript:" class="weui-btn  weui-btn_plain-primary" id="submitPreview">预 览</a>
			<a class="weui-btn weui-btn_primary" href="javascript:" id="submitlending">确定记录</a>
		</div>
		<input type="hidden" name="preview" id="preview" value="0">
		<input type="hidden" name="title" id="title" value="0">
</form>
<!--放贷表单 end;-->
</div>
<div id="income_div" class="weui-tab__bd-item">
	<!--最近收款列表 begin:-->
	<div class="weui-cells__title">近期收款提示</div>
	<div class="weui-cells" id="incomeList"></div>
	<!--最近收款列表 end; -->
</div>
<div id="user_div" class="weui-tab__bd-item">
	<!--借贷人列表 begin:-->
	<div class="weui-cells__title"><a href="javascript:toUserAdd();" class="weui-btn weui-btn_mini weui-btn_default">添加客户</a></div>
	<div class="weui-cells" id="userList"></div>
	<!--借贷人列表 end;-->
	<!--借贷人详细 begin:-->
	<div class="weui-cells" id="userDetail"></div>
	<!--借贷人详细 end;-->
	<!--贷款人表单 begin:-->
	<form id="formuser" onsubmit="return false;"  style="display:none;">
			<div class="weui-cells weui-cells_form">
				<div class="weui-cell">
					<div class="weui-cell__hd">
						<label class="weui-label">贷款人</label>
					</div>
					<div class="weui-cell__bd">
						<input class="weui-input" name="name" type="text" placeholder="贷款人姓名" pattern="^[\u4e00-\u9fa5]{1,7}$|^[\dA-Za-z_]{1,14}$">
					</div>
					<div class="weui-cell__ft">
					</div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__hd"><label class="weui-label">手机号码</label></div>
					<div class="weui-cell__bd">
						<input class="weui-input" type="tel" name="phone"  maxlength="11"  placeholder="请输入贷款人手机号码">
					</div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__hd"><label class="weui-label">身份证号</label></div>
					<div class="weui-cell__bd"><input class="weui-input" type="text" name="cardno"  maxlength="18"  placeholder="请输入客户的身份证号码"></div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__hd"><label class="weui-label">备用电话</label></div>
					<div class="weui-cell__bd">
						<input class="weui-input" type="tel" name="phone_bak"  maxlength="11"  placeholder="请输入贷款人备用电话">
					</div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__hd"><label class="weui-label">家庭住址</label></div>
					<div class="weui-cell__bd">
						<input class="weui-input" type="text" name="address" value="" maxlength="100"  placeholder="请输入家庭住址">
					</div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__hd"><label class="weui-label">备注说明</label></div>
					<div class="weui-cell__bd">
						<input class="weui-input" type="text" name="bak" value="" maxlength="100"  placeholder="请输入备注说明">
					</div>
				</div>
			</div>
			<div class="weui-btn-area">
				<a class="weui-btn weui-btn_primary" href="javascript:" id="submituser">确定记录</a>
				<a class="weui-btn weui-btn_plain-primary searchCredit" rel="0" href="javascript:" style="display:none;">查阅征信</a>
				<a href="javascript:toUserList()" class="weui-btn  weui-btn_default">返 回</a>
			</div>
			<input type="hidden" name="act" value="add">
			<input type="hidden" name="userid" value="">
	</form>
	<!--贷款人表单 end;-->
</div>
<div id="setting_div" class="weui-tab__bd-item">
	<div class="weui-cells__title">帐号相关</div>
	<div class="weui-cells">
				<div class="weui-cell">
			<div class="weui-cell__bd"><p>当前帐号：<span id="cust_username">wengshaohui@163.com</span></p></div>
			<div class="weui-cell__ft"><a href="javascript:logout();" class="weui-btn weui-btn_mini weui-btn_warn">退 出</a></div>
		</div>
		<a class="weui-cell weui-cell_access" href="javascript:editPasswd();"><div class="weui-cell__bd"><p>密码修改</p></div><div class="weui-cell__ft"></div></a>
				<!--
		<a class="weui-cell weui-cell_access" href="javascript:editPhone();"><div class="weui-cell__bd"><p>手机号码：<span id="cust_phone"></span></p></div><div class="weui-cell__ft"></div>
		</a>-->
		<a class="weui-cell weui-cell_access" href="javascript:editEmail();"><div class="weui-cell__bd"><p>邮箱：<span id="cust_email">wengshaohui@163.com</span></p></div><div class="weui-cell__ft"></div>
		</a>
		<div class="weui-btn-area"><a href="javascript:toRechargeDiv(80739,'#setting_div')" class="weui-btn weui-btn_plain-primary">帐户充值</a></div>
	</div>
	<div class="weui-cells__title">参数配置</div>
	<div class="weui-cells">
		<a class="weui-cell weui-cell_access" href="javascript:editLendRate();"><div class="weui-cell__bd"><p>常用利率设置：当前<span id="cfg_lendrate">10</span>%月利率</p></div><div class="weui-cell__ft"></div></a>
		<a class="weui-cell weui-cell_access" href="javascript:editIncomeNearly();"><div class="weui-cell__bd"><p>提醒天数设置：当前为<span id="cfg_incomenearly">7</span>天内提醒</p></div><div class="weui-cell__ft"></div></a>
		<a class="weui-cell weui-cell_access" href="javascript:toTipsSmsDiv();"><div class="weui-cell__bd"><span style="vertical-align: middle">短信提醒设置</span></div><div class="weui-cell__ft"></div></a>
		<a class="weui-cell weui-cell_access" href="javascript:toTipsSmsUsers();"><div class="weui-cell__bd"><span style="vertical-align: middle">短信提醒借款人名单</span></div><div class="weui-cell__ft"></div></a>	</div>
	<div class="weui-cells__title">版本信息</div>
	<div class="weui-cells">
		<a class="weui-cell weui-cell_access" href="javascript:toFeedbackDiv();"><div class="weui-cell__bd"><p>提意见或建议</p></div><div class="weui-cell__ft"></div></a>
		 <a class="weui-cell weui-cell_access" href="javascript:toUpgradeDiv();">
		<div class="weui-cell__bd"><p>版本号：v2.11</p></div>
		<div class="weui-cell__ft">查看更新日志</div>
		</a>
	</div>
	<div class="weui-footer weui-footer_fixed-bottom">
		<p class="weui-footer__text">Copyright © 2017-2020 yuyaoit.cn</p>
	</div>
</div>
<div id="credit_div" class="weui-tab__bd-item">
	<div class="weui-cells__title">我的征信查询日志</div>
	<header class="acc-header"><h1 class="acc-title">暂无查询过的征信记录</h1></header>
	<p class="weui-btn-area"><a href="#" class="weui-btn weui-btn_plain-primary searchCredit" style="line-height:2;">征信查询</a></p>
	<div class="weui-cells" id="CreditList"></div>
	<a href="javascript:CreditSearchMore();" class="weui-btn weui-btn_default" id="creditlog-more">查看更多</a>
</div>
</div>
	<div class="weui-tabbar" id="nav_bottom">
		<a href="#index_div" class="weui-tabbar__item weui-bar__item--on" id="index_btn">
			<div class="weui-tabbar__icon">
				<img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/24.png" alt="">
			</div>
			<p class="weui-tabbar__label">首页</p>
		</a>
		<a  class="weui-tabbar__item" id="lending_btn">
			<div class="weui-tabbar__icon">
				<img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/25.png" alt="">
			</div>
			<p class="weui-tabbar__label">放贷</p>
		</a>
		<a  class="weui-tabbar__item" id="income_btn">
			<span class="weui-badge" style="position: absolute;top: -.4em;right: 1em;display:none;" id="incomeCount">0</span>
			<div class="weui-tabbar__icon">
				<img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/26.png" alt="">
			</div>
			<p class="weui-tabbar__label" id="income">收款</p>
		</a>
		<a href="#user_div" class="weui-tabbar__item" id="user_btn">
			<div class="weui-tabbar__icon">
				<img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/7.png" alt="">
			</div>
			<p class="weui-tabbar__label">客户</p>
		</a>
		<a href="#setting_div" class="weui-tabbar__item" id="setting_btn">
						<div class="weui-tabbar__icon">
				<img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/17.png" alt="">
			</div>
			<p class="weui-tabbar__label">设置</p>
		</a>
	</div>
</div>
<script src="https://app.accounting.yuyaoit.cn/themes/jqweui/lib/jquery.min.js"></script>
<script src="https://app.accounting.yuyaoit.cn/themes/jqweui/lib/fastclick.min.js"></script>
<script src="https://app.accounting.yuyaoit.cn/themes/jqweui/js/jquery-weui.min.js"></script>
<script>
var URL = 'https://app.accounting.yuyaoit.cn/';
var BASE = 'https://app.accounting.yuyaoit.cn/';
$(function() {FastClick.attach(document.body);});
lend = {};
lendhistory = {};
user = {};
income = {};
customer = {"custid":"80739","username":"wengshaohui@163.com","email":"wengshaohui@163.com","name":null,"phone":null,"config":{"lendrate":10,"incomenearly":7},"money":"0.00"};
customer.update = 1;
incomeNearly = {};
incomeOverdue = {};
lend.update = 0;
lendhistory.update = 0;
user.update = 0;
income.update = 0;
incomeNearly.update = 0;
incomeOverdue.update = 0;
lendcfg = {};
lendcfg.paymentType = new Array();
lendcfg.paymentType[1] = '等额本息';
lendcfg.paymentType[2] = '先息后本';
lendcfg.stage = new Array();
lendcfg.stage[1] = '天';
lendcfg.stage[7] = '周';
lendcfg.stage[10] = '十日';
lendcfg.stage[15] = '十五日';
lendcfg.stage[30] = '月';
lendcfg.rate = new Array();
lendcfg.rate[1] = '日息';
lendcfg.rate[7] = '周息';
lendcfg.rate[10] = '十日息';
lendcfg.rate[15] = '十五日息';
lendcfg.rate[30] = '月息';
indexBadgeTips = {"nearly":null,"overdue":null};
indexBadgeTips.update = 1;
tipssms = {};
tipssms.open = 1;
tipssms.ids = new Array();
tipssms.update = 0;
account = {};
account.data = new Array();
account.update = 0;
creditlog = {};
creditlog.update = 0;
creditlog.curpage = 1;
var version = 'v2.11';
var today = "2019-03-25";
var curdaytime = 1553529599;
var userHasLending = false;
var authType = '';
function setOverDay(begindate, circle){
	var days = parseInt($("input[name='circle']").val()) * parseInt(circle);
	var d = new Date(begindate); 
	d.setDate(d.getDate()+days); 
	var m = d.getMonth()+1; 
	$("#overday").html(d.getFullYear()+'-'+m+'-'+d.getDate());
}
Date.prototype.diff = function(date){return Math.ceil(Math.abs((this.getTime() - date.getTime())/86400000));}
function getUserData(){
	if (user.update == 0){
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/user/getData", async:false,dataType:'json',success:function(d){
			if (d.code == '1') {
				var ud = d.msg;
				if (!user.data) user.data = new Array();
				for (var i=0;i<ud.length;i++){user.data[ud[i].userid] = ud[i];}
				user.update = 1;
			}
		}});
	}
}
function getLendData(){
	if (lend.update == 0){
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/lending/getData", async:false,dataType:'json',success:function(d){
			if (d.code == '1') {
				var ud = d.msg;
//				if (!lend.data)
				lend.data = new Array();
				for (var i=0;i<ud.length;i++){lend.data[ud[i].lendid] = ud[i];}
				lend.update = 1;
			}
		}});
	}
	return lend;
}
function getLendHistoryData(){
	if (lendhistory.update == 0){
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/lending/getData/history", async:false,dataType:'json',success:function(d){
			if (d.code == '1') {
				var ud = d.msg;
				if (!lendhistory.data) lendhistory.data = new Array();
				for (var i=0;i<ud.length;i++){lendhistory.data[ud[i].lendid] = ud[i];}
				lendhistory.update = 1;
			}
		}});
	}
	return lendhistory;
}
function getIncomeDataByLend(lendid, _type){
//	var _type = arguments[1] ? 'history' : 'current';
	if ((income.update ==0) || !income.data[lendid]) {
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/income/getData", data:"acType=bylend&type="+_type+"&lendid="+lendid, async:false,dataType:'json',success:function(d){
			if (d.code == '1'){
				if (!income.data) income.data = new Array();
				for (var k in d.msg){
					if (!income.data[lendid]) income.data[lendid] = new Array();
					income.data[lendid][d.msg[k].incomeid] = d.msg[k];
				}
//				income.data[lendid] = d.msg;
				income.update = 1;
			}
		}});
	}
	return income;
}
function getIncomeData(type){
	if ((type == 'nearly') && (incomeNearly.update == 0)){
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/income/getData", data:"acType="+type, async:false,dataType:'json',success:function(d){
			if (d.code == '1'){
				incomeNearly.data = new Array();
				incomeNearly.data = d.msg;
				incomeNearly.update = 1;
			}
		}});
		return incomeNearly;
	}else if ((type == 'overdue') && (incomeOverdue.update == 0)){
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/income/getData", data:"acType="+type, async:false,dataType:'json',success:function(d){
			if (d.code == '1'){
				incomeOverdue.data = new Array();
				incomeOverdue.data = d.msg;
				incomeOverdue.update = 1;
			}
		}});
		return incomeOverdue;
	}
	return false;
}
function setIncomeOver(lendid, incomeid){
	$.modal({
	  title: "请输入真实收款日期:",
	  text: '<input class="weui-input weui-prompt-input" id="income_realday" value="'+today+'" type="date">',
	  buttons: [
		{ text: "取消", className: "default"},
		{text: "完成收款", onClick: function(){
			$.showLoading('正在处理中');
			$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/income/setOver", data:"lendid="+lendid+"&incomeid="+incomeid+"&incomeday="+$("#income_realday").val(), async:false,dataType:'json',success:function(d){
				$.hideLoading();
				if (d.code == '1'){
					incomeOverdue.update = 0;
					incomeNearly.update = 0;
					income.update = 0;
					income.data[d.lendid][d.incomeid].status = d.msg.status;
					income.data[d.lendid][d.incomeid].income_realday = d.msg.income_realday;
					lend.update = 0;
					indexBadgeTips.update = 0;
					$("#lendingList").html(setLendData());
					lendhistory.update = 0;
					$.toast("操作成功");
					hideIncomeDetail();
					var obj = $("#income_div").find("div[data='"+d.lendid+"|"+d.incomeid+"']");
					obj.find(".weui-cell__ft").html("<i class='weui-icon-success'></i>");
				}
			}});
		}},
	  ]
	});
}
function setIncomeDelay(lendid, incomeid){
	var org_date = income.data[lendid][incomeid].income_day;
	$.modal({
	  title: "请输入要延期收款的日期:",
	  text: '<input class="weui-input weui-prompt-input" id="income_delayday" value="'+today+'" type="date">',
	  buttons: [
		{ text: "取消", className: "default"},
		{text: "延长收款", onClick: function(){
			$.showLoading('正在处理中');
			$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/income/setDelay", data:"lendid="+lendid+"&incomeid="+incomeid+"&org_date="+org_date+"&delayday="+$("#income_delayday").val(), async:false,dataType:'json',success:function(d){
				$.hideLoading();
				if (d.code == '1'){
					indexBadgeTips.update = 0;
					incomeOverdue.update = 0;
					income.data[d.lendid][d.incomeid].income_day = d.msg.income_day;
					income.data[d.lendid][d.incomeid].bak = (!!income.data[d.lendid][d.incomeid].bak) ? income.data[d.lendid][d.incomeid].bak + d.msg.bak : d.msg.bak;
					$.toast("操作成功");
					hideIncomeDetail();
					toIncomeDiv('overdue');
				}
			}});
		}},
	  ]
	});
}
function hideLendingDetail(){$("#lendingPreview").remove();}
function hideIncomeDetail(){$("#incomeDetail").remove();}
function delLendingDetail(lendid,type){
	$.confirm("确认要删除该笔放贷记录吗？<br/>1.其下收款记录将被删除<br/>2.其下额外帐目将被删除", function() {
	//点击确认后的回调函数
		$.showLoading('正在处理中');
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/lending/delData", data:"lendid="+lendid+"&type="+type, async:false,dataType:'json',
			success:function(d){
				if (d.code == '1'){
					if (type=='current'){
						delete (lend.data[d.msg]);
						income.update = 0;
						incomeNearly.update = 0;
						incomeOverdue.update = 0;
						indexBadgeTips.update = 0;
						$("#lendingList").html(setLendData());
					}else if (type == 'history'){
						delete (lendhistory.data[d.msg]);
						toLendingHistoryList();
					}
					$.toast("删除成功",1000);
					hideLendingDetail();
				}else{
					$.showLoading('请刷新后重试','forbidden');
				}
			}
		});
	}, function() {
	//点击取消后的回调函数
	});
}
function setLendingOver(lendid){
	$.confirm("确认要把这笔放贷记录设置为完成吗？", function() {
		$.showLoading('正在处理中');
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/lending/setOver", data:"lendid="+lendid, async:false,dataType:'json',
			success:function(d){
				if (d.code == '1'){
					delete (lend.data[d.msg]);
					lendhistory.update = 0;
					income.update = 0;
					incomeNearly.update = 0;
					incomeOverdue.update = 0;
					lend.update = 0;
					indexBadgeTips.update = 0;
					$("#lendingList").html(setLendData());
					$.toast("设置成功",1000);
					hideLendingDetail();
				}else{
					$.showLoading('请刷新后重试','forbidden');
				}
			}
		});
	}, function() {
	});
}
function setSearchDiv(){
	return '<div class="weui-search-bar " ><form class="weui-search-bar__form"><div class="weui-search-bar__box"><i class="weui-icon-search"></i><input type="search" class="weui-search-bar__input"  placeholder="搜索" required=""><a href="javascript:" class="weui-icon-clear"></a></div><label class="weui-search-bar__label" ><i class="weui-icon-search"></i><span>搜索</span></label></form><a href="javascript:" class="weui-search-bar__cancel-btn" >取消</a></div>';
}
function showLendingDetail(lendid, type, objdiv){
	$("#lendingPreview").remove();
	var obj;
	var tips_income_status = '';
	if (type=="preview"){
		var _objdata = arguments[3] ? arguments[3] : {} ;
		var objincome = _objdata.incomedata;
		obj =  _objdata.lenddata;
		obj.lendid = lendid;
		(!!_objdata.userdata) ? user.update = 0  : '';
	}else{
		obj = (type == 'history') ? lendhistory.data[lendid] : lend.data[lendid];
		tips_income_status = (type == 'history') ? '<div class="weui-cells__title" style="text-align:center;font-size:16px;color:red;">已截止收款</div>' : '<div class="weui-cells__title" style="text-align:center;font-size:16px;color:green;"></div>';
	}
	if (!!obj){
		getUserData();
		var str = '<div id="lendingPreview" class="weui-popup__container" style="z-index:501;">';
		str += '<div class="weui-popup__overlay"></div>';
		str += '<div class="weui-popup__modal">';
			str += '<div class="bd"><div class="page__bd"><div class="weui-cells__title">'+obj.title+'</div><div class="weui-cells">';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>贷款人</p></div><div class="weui-cell__ft">'+user.data[obj.userid].name+'</div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>联系电话</p></div><div class="weui-cell__ft"><a href="tel:'+user.data[obj.userid].phone+'">'+user.data[obj.userid].phone+'</a></div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>放贷金额</p></div><div class="weui-cell__ft">'+obj.money+'元</div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>放贷利息</p></div><div class="weui-cell__ft">'+(obj.rate*100).toFixed(2)+'% '+lendcfg.rate[obj.rate_unit]+'</div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>放贷时间</p></div><div class="weui-cell__ft">'+obj.beginday+'</div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>放贷到期</p></div><div class="weui-cell__ft">'+obj.overday+'</div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>收款方式</p></div><div class="weui-cell__ft">'+lendcfg.paymentType[obj.income_type]+'</div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>收款分期</p></div><div class="weui-cell__ft">分'+obj.stage+'期【每'+lendcfg.stage[obj.stage_unit]+'1期】</div></div>';
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>服务费</p></div><div class="weui-cell__ft">'+obj.fee+'元</div></div>';
			str += (obj.bak!='') ? '<div class="weui-cell"><div class="weui-cell__bd"><p>备注说明</p></div><div class="weui-cell__ft">'+obj.bak+'</div></div>' : '';
			if (type == 'preview'){
				str += '<div class="weui-cells__title">收款计划明细</div>';
				if (!!objincome){
					var tips,incomeTips;
					for(var k in objincome){
						incomeTips = (obj.income_type=='2') ? ('收'+((objincome[k].corpus>'0') ? '回本金'+objincome[k].corpus : '利息'+objincome[k].income)) : '收本收息'+objincome[k].income;
						tips = (objincome[k].status == '2') ? 'weui-icon-success' : (objincome[k].income_day > today) ? 'weui-icon-waiting' : 'weui-icon-warn';
						str += '<div class="weui-cell"><div class="weui-cell__bd"><p>'+objincome[k].income_day+'</p></div><div class="weui-cell__ft">'+((objincome[k].stageid == 1) ? '当天' : '')+incomeTips+'元<i class="'+tips+'"></i></div></div>';
					}
				}
				str += '<div class="weui-cells__title">应放款 = 贷款金额 - 服务费 - 第1次收取</div>';
				str += '<div class="weui-cells__title">应放款：'+(obj.money-obj.fee-objincome[0].income).toFixed(2)+'元</div>';
			}else{
				str += '<div class="weui-cell"><div class="weui-cell__bd"><p>记录时间</p></div><div class="weui-cell__ft">'+obj.ctime+'</div></div>';
				str += '<div class="weui-cells__title">收款执行情况</div>';
				str += (obj.stage_over>0) ? '<div class="weui-cell"><div class="weui-cell__bd"><p>执行收款</p></div><div class="weui-cell__ft">已执行了'+obj.stage_over+'次收款</div></div>' : tips_income_status;
				str += (!!obj.pay_first) ? '<div class="weui-cell"><div class="weui-cell__bd"><p>第一次收款</p></div><div class="weui-cell__ft">'+obj.pay_first+'</div></div>' : '';
				str += (!!obj.pay_last) ? '<div class="weui-cell"><div class="weui-cell__bd"><p>最近一次收款</p></div><div class="weui-cell__ft">'+obj.pay_last+'</div></div>' : '';
			}
			str += '</div></div></div>';
			if (type == 'preview'){
				str += '<div class="weui-btn-area"><a href="javascript:hideLendingDetail();" class="weui-btn  weui-btn_default">关闭预览</a></div>';
			}else{
				str += '<div style="text-align: center;"><a	href="javascript:toAccountItemDiv('+obj.userid+','+lendid+',0,\''+objdiv+'\');" class="weui-btn weui-btn_mini weui-btn_plain-primary">+ 记一笔收支</a>&nbsp;&nbsp;<a href="javascript:toAccountListDiv('+obj.userid+','+lendid+',0,\''+objdiv+'\');" class="weui-btn weui-btn_mini weui-btn_plain-primary">查看额外收支</a></div>';
				str += '<div class="weui-btn-area">';
				str += '<a href="javascript:showAccountTotalByLend('+obj.lendid+',\''+type+'\',\''+objdiv+'\');" class="weui-btn weui-btn_plain-primary">查看该笔放贷营收</a>';
				str += '<a href="javascript:toIncomeList('+obj.lendid+',\''+type+'\');" class="weui-btn weui-btn_plain-primary">查看收款记录</a>';
				if (type == 'current') str += '<a href="javascript:setLendingOver('+obj.lendid+');" class="weui-btn weui-btn_primary">设置完成放贷</a>';
				str += '<a href="javascript:delLendingDetail('+obj.lendid+',\''+type+'\');" class="weui-btn weui-btn_warn">删除该笔放贷</a>';
				str += '<a href="javascript:hideLendingDetail();" class="weui-btn  weui-btn_default">关闭详情页</a>';
				str += '</div>';
			}
		str += '</div>';
		str += '</div>';
		(type == 'preview') ? $("#formlending").append(str) : $(objdiv).append(str);
		$("#lendingPreview").popup();
	}
}
function showIncomeDetail(lendid, incomeid, type){
	var obj;
	getIncomeDataByLend(lendid, type);
	obj = income.data[lendid][incomeid];
	if (!!obj){
		var str = '<div id="incomeDetail" class="weui-popup__container" style="z-index:502;">';
		str += '<div class="weui-popup__overlay"></div>';
		str += '<div class="weui-popup__modal">';
		str += '<div class="bd"><div class="page__bd"><div class="weui-cells__title">'+obj.title+'</div><div class="weui-cells">';
		str += '<div class="weui-cell"><div class="weui-cell__bd"><p>贷款人</p></div><div class="weui-cell__ft">'+obj.name+'</div></div>';
		str += '<div class="weui-cell"><div class="weui-cell__bd"><p>联系电话</p></div><div class="weui-cell__ft"><a href="tel:'+obj.phone+'">'+obj.phone+'</a></div></div>';
		if (obj.income_type=='2'){
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>收款金额【'+('收'+((obj.corpus>'0.00') ? '本金' : '利息'))+'】</p></div><div class="weui-cell__ft">'+obj.income+'元</div></div>';
		}else if (obj.income_type=='1'){
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>收款金额【收本收息】</p></div><div class="weui-cell__ft">'+obj.income+'元</div></div>';
		}
		str += '<div class="weui-cell"><div class="weui-cell__bd"><p>预期收款日</p></div><div class="weui-cell__ft">'+obj.income_day+'</div></div>';
		if (!!obj.income_realday) str += '<div class="weui-cell"><div class="weui-cell__bd"><p>实际收款日</p></div><div class="weui-cell__ft">'+obj.income_realday+'</div></div>';
		if (type == 'history'){
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>收款状态</p></div><div class="weui-cell__ft">'+((obj.status == '2') ? '完成收款<i class="weui-icon-success-no-circle"></i>' : '未收到款<i class="weui-icon-cancel"></i>')+'</div></div>';
		}else{
			var now = new Date();
			var _overdays = now.diff(new Date(obj.income_day)) - 1 ;
			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>收款状态</p></div><div class="weui-cell__ft">'+((!!obj.income_realday) ? '<i class="weui-icon-success-no-circle"></i>完成收款 ' : (_overdays==0) ? '<i class="weui-icon-info-circle "></i>今天是收款日' : (obj.income_day < today) ? '<i class="weui-icon-warn"></i>已逾期'+_overdays+'天':'<i class="weui-icon-waiting"></i>离收款日还有'+_overdays+'天')+'</div></div>';

			str += '<div class="weui-cell"><div class="weui-cell__bd"><p>系统提醒次数</p></div><div class="weui-cell__ft">'+obj.tips+'次</div></div>';
						getTipsSmsData();
			if (obj.status != '2'){
				str += '<div class="weui-cell weui-cell_switch">';
				str += '<div class="weui-cell__bd">加入短信提醒名单</div>';
				str += '<div class="weui-cell__ft"><label for="setTipsSmsByIncome" class="weui-switch-cp"><input id="setTipsSmsByIncome" class="weui-switch-cp__input setTipsSmsBySwitch" type="checkbox" value="'+obj.userid+'" '+(($.inArray(obj.userid+"",tipssms.ids) >=0) ? ' checked="checked"' : '')+'><div class="weui-switch-cp__box"></div></label></div></div>';
			}
					}

		str += (!!obj.bak) ? '<div class="weui-cell"><div class="weui-cell__bd"><div class="weui-cells__tips">备注说明：<br/>'+obj.bak+'</div></div></div>' : '';
		str += '</div></div></div>';
		str += '<div style="text-align: center;"><a	href="javascript:toAccountItemDiv('+obj.userid+','+obj.lendid+','+obj.incomeid+',\'#income_div\');" class="weui-btn weui-btn_mini weui-btn_plain-primary">+ 记一笔收支</a>&nbsp;&nbsp;<a href="javascript:toAccountListDiv('+obj.userid+','+obj.lendid+','+obj.incomeid+',\'#income_div\');" class="weui-btn weui-btn_mini weui-btn_plain-primary">查看额外收支</a></div>';
		str += '<div class="weui-btn-area">';
		if (obj.status == '0'){
			str += '<a href="javascript:setIncomeOver('+obj.lendid+','+obj.incomeid+');" class="weui-btn weui-btn_primary">设置完成收款</a>';
			str += '<a href="javascript:setIncomeDelay('+obj.lendid+','+obj.incomeid+');" class="weui-btn weui-btn_plain-primary">设置延期收款</a>';
		}
		str += '<a href="javascript:hideIncomeDetail();" class="weui-btn  weui-btn_default">关闭详情页</a>';
		str += '</div>';
		str += '</div></div>';
		$("#incomeList").append(str);
		$("#incomeDetail").popup();
	}
}
function toIncomeList(lendid, type){
	hideLendingDetail();
	toIncomeDiv();
	if (type == 'current'){
		$("#incomeList").html(setIncome('bylend', lendid, '<a href="javascript:toLendingList();" class="weui-btn weui-btn_mini weui-btn_default">返回放贷列表</a>'));
	}else if(type == 'history') {
		$("#incomeList").html(setIncome('history', lendid, '<a href="javascript:toLendingHistoryList();" class="weui-btn weui-btn_mini weui-btn_default">返回历史放贷列表</a>'));
	}
}
function showLendMsg(lendid){
	var str = '<div id="msgPages" class="weui-popup__container" style="z-index:9999999">';
		str += '<div class="weui-popup__overlay"></div>';
		str += '<div class="weui-popup__modal">';
		str += '<div class="weui-msg">';
		str += '<div class="weui-msg__icon-area"><i class="weui-icon-success weui-icon_msg"></i></div>';
		str += '<div class="weui-msg__text-area">';
		str += '<h2 class="weui-msg__title">操作成功</h2>';
		str += '<p class="weui-msg__desc">放贷记录成功添加，现在您可以进入以下操作：</p>';
		str += '</div>';
		str += '<div class="weui-msg__opr-area">';
		str += '<p class="weui-btn-area">';
		str += '  <a href="javascript:hideLendMsg();" class="weui-btn weui-btn_plain-primary">继续添加</a>';
		str += '  <a href="javascript:hideLendMsg();toIncomeList('+lendid+',\'current\');" class="weui-btn weui-btn_primary">进入收款列表</a>';
		str += '  <a href="javascript:hideLendMsg();toLendingList();" class="weui-btn weui-btn_primary">进入放贷列表</a>';
		str += '</p>';
		str += '</div></div></div></div>';
	$("#lending_div").append(str);
	$("#msgPages").popup();
}
function hideLendMsg(){$("#msgPages").remove();}
function incomeTpl(data, title, type){
	var list = '';
	var i = 1;
	if (data.length==0){
		return '<header class="acc-header"><h1 class="acc-title">'+title+'</h1></header><div class="acc-content-padded"><a href="javascript:;" class="weui-btn weui-btn_primary goLending">去放贷</a></div>';
	}
	var tips = '';
	for (var k in data){
		if (type == 'current'){
			tips = (data[k].status == '2') ? 'weui-icon-success' : (data[k].income_day > today) ? 'weui-icon-waiting' : (data[k].income_day == today) ? 'weui-icon-info-circle' : 'weui-icon-warn';
		}else{
			tips = (data[k].status == '2') ? 'weui-icon-success' : 'weui-icon-cancel';
		}
		var str = '<div class="weui-cell weui-cell_access income_'+type+'" data="'+data[k].lendid+'|'+data[k].incomeid+'">';
			str += '<div class="weui-cell__bd">';
			if (data[k].income_type=='2'){
				str += '<span style="vertical-align: middle"><i>('+i+')</i> '+data[k].income_day+'向'+data[k].name+('收'+((data[k].corpus>'0.00') ? '<span class="green">本金</span>'+data[k].corpus : '<span class="red">利息</span>'+data[k].income))+'元</span>';
			}else if (data[k].income_type=='1'){
				str += '<span style="vertical-align: middle"><i>('+i+')</i> '+data[k].income_day+'向'+data[k].name+'收本收息'+data[k].income+'元</span>';
			}

			str += '<span class="weui-badge" style="margin-left: 5px;background-color:#3cc51f;">第'+data[k].stageid+'次收</span>';
			str += '</div>';
			str += '<div class="weui-cell__ft"><i class="'+tips+'"></i></div>';
			str += '</div>';
			str += '<div class="weui-cells__tips">来源:'+data[k].title+'</div>';
		list += str;
		i++;
	}
	return list;
}
function setIncome(type){
	switch(type){
		case 'nearly':
			$("#income_div").find(".weui-cells__title").html('最近'+customer.config.incomenearly+'天收款提醒'+setSearchDiv());
			getIncomeData(type);
			return incomeTpl(incomeNearly.data,'最近'+customer.config.incomenearly+'天内无收款','current');
			break;
		case 'overdue':
			$("#income_div").find(".weui-cells__title").html('已逾期的收款记录'+setSearchDiv());
			getIncomeData(type);
			return incomeTpl(incomeOverdue.data,'还没有逾期的收款记录','current');
			break;
		case 'bylend':
			var lendid = arguments[1] ? arguments[1] : 0 ;
			getIncomeDataByLend(lendid, 'current');
			var title = arguments[2] ? arguments[2] : lend.data[lendid].title+'元共'+lend.data[lendid].stage+'期' ;
			$("#income_div").find(".weui-cells__title").html(title);
			return incomeTpl(income.data[lendid],'没有收款记录','current');
			break;
		case 'history':
			var lendid = arguments[1] ? arguments[1] : 0 ;
			getIncomeDataByLend(lendid, 'history');
			var title = arguments[2] ? arguments[2] : lendhisotry.data[lendid].title+'元共'+lendhisotry.data[lendid].stage+'期' ;
			$("#income_div").find(".weui-cells__title").html(title);
			return incomeTpl(income.data[lendid],'没有收款记录', 'history');
			break;
	}
}
function setLendData(){
	var lend = arguments[0] ? getLendHistoryData() : getLendData();
	var type = arguments[0] ? 'lend_history' : 'lend_current';
	if (lend.data.length==0){
		return '<header class="acc-header"><h1 class="acc-title">'+((type=='lend_history') ? '暂无历史放贷记录' : '暂无进行中的放贷记录')+'</h1></header><div class="acc-content-padded"><a href="javascript:;" class="weui-btn weui-btn_primary goLending">去放贷</a></div>';
	}
	var list = '';
	var tips_icon = '';
	var tips_text = '';
	var tips_prog = '100';
//	var totaldays;
	var sortData=[].concat(lend.data);
	if (type == 'lend_current')
		sortData.sort(function(a, b){return (a.leftday - b.leftday);});
	else 
		sortData.sort(function(a, b){return (a.mtime < b.mtime);});
	var i = 1;
	for (var k in sortData){
		if (sortData[k].status > '0') {	// 历史
			tips_icon = (sortData[k].status == '2') ? 'weui-icon-success' : 'weui-icon-info-circle';
			tips_text = '已执行了' + sortData[k].stage_over + '次收款';
		}else{
			tips_icon = (sortData[k].overday > today) ? 'weui-icon-waiting' : (sortData[k].overday == today) ? 'weui-icon-info-circle' : 'weui-icon-warn';
			tips_text = '已执行了' + sortData[k].stage_over + '次收款,'+((sortData[k].leftday > '0') ? '离截止日剩'+sortData[k].leftday+'天' : (sortData[k].leftday == '0') ? '今天是放贷载止日' : ('已超期'+Math.abs(sortData[k].leftday)+'天'));
		}
		tips_prog = (sortData[k].income_type=='1') ?  Math.ceil((sortData[k].stage_over-1)/sortData[k].stage * 100) :  Math.ceil((sortData[k].stage_over)/sortData[k].stage * 100);
		var str = '<div class="weui-cell weui-cell_access '+type+'" data="'+sortData[k].lendid+'">';
			str += '<a class="weui-cell__bd">';
			str += '<span style="vertical-align: middle"><i>('+i+')</i> '+sortData[k].title+'元</span>';
			str += '<span class="weui-badge" style="margin-left: 5px;background-color:#3cc51f">'+(sortData[k].income_type=='2' ? '先息后本' : '等额本息')+'共'+sortData[k].stage+'期</span>';
			str += '<span class="weui-badge" style="margin-left: 5px;background-color:#3cc51f">已收回'+sortData[k].income_sum+'元</span>';
			str += '</a>';
			str += '<div class="weui-cell__ft"><i class="'+tips_icon+'"></i></div>';
			str += '</div>';
			str += '<div class="weui-progress"><div class="weui-progress__bar"><div class="weui-progress__inner-bar js_progress" style="width: '+tips_prog+'%;"></div></div><span class="prog-tips">'+tips_text+'</span></div>';
		list += str;
		i++;
	}
	return list;
}

function setInitUser(){
	getUserData();
	var ret = new Array();
	if (user.update){
		for(var k in user.data){
			if (!!user.data[k].name){
				var _obj = {};
				_obj.title = user.data[k].name;
				_obj.value = user.data[k].phone;
				ret.unshift(_obj);
			}
		}
	}
	ret.sort((a, b) => a.title.localeCompare(b.title));
	return ret;
}
function calculationIncomeItem(){
	var str = '<div class="weui-cells__tips">';
	var rateunit = parseInt($("#rate_unit").val());
	var money = parseInt($("#formlending").find("input[name='money']").val());
	if ((rateunit >0) && (money > 0)){
		var rate = parseFloat($("#formlending").find("input[name='rate']").val());
		var stageMoney = new Array();
		for (var k in lendcfg.stage){
			stageMoney[k] = (money *(k*rate/rateunit/100)).toFixed(2);
			str += '每'+lendcfg.stage[k]+'可得利息：'+ stageMoney[k] +'元<br/>';
		}
		$("#calculationItemShow").html(str+'</div>');
		var stage = parseInt($("#formlending").find("input[name='stage']").val());
		var stageunit = parseInt($("#stage_unit").val());
		$("#calculationStageShow").html('<div class="weui-cells__tips">每期可得利息：'+stageMoney[stageunit]+'元<br/>总计可得利息：'+(stage*stageMoney[stageunit]).toFixed(2)+'元</div>');
	}
}
function calculationStage(days){
//	$("input[name='stage']").val(Math.ceil(parseInt($("input[name='circle']").val() * $("#circle_unit").val())/$("#stage_unit").val()));
}
function toIncomeDiv(){
	$.showLoading('正在处理中');
	(arguments[0]) ? $("#incomeList").html(setIncome(arguments[0])) : '';
	$(".weui-tab__bd-item").removeClass("weui-tab__bd-item--active");
	$("#income_div").addClass("weui-tab__bd-item--active");
	$("#nav_bottom").find(".weui-tabbar__item").removeClass("weui-bar__item--on");
	$("#income_btn").addClass("weui-bar__item--on");
	$.hideLoading();
}
function toCountDiv(){
	$.ajaxSetup({cache: true});
	$.getScript(BASE+"themes/jqweui/accounting/total.js?"+version, function(){getTotal('week');});
}
myBorrow = {};
myBorrow.data = new Array();
myBorrow.update = 0;
function toBorrowDiv(){
	$.closeModal();
	if (!!myBorrow.info){
		toBorrowList();
	}else{
		$.ajax({type:"GET",url:"https://app.accounting.yuyaoit.cn/buss/getBorrowerBySelf", cache:true,async:false,dataType:'json',success:function(d){
			if (d.code == '1'){$("#index_div").append(d.msg);$("#borrow_div").popup();} else if(d.code=='2'){myBorrow.info = d.data;toBorrowList()}
		}});
	}
}
function toBorrowList(){
	$.ajaxSetup({cache: true});
	$.getScript(BASE+"themes/jqweui/accounting/borrow.js?"+version+'.1', function(){showBorrowList();});
}
function toFeedbackDiv(){
	if ($("#feedback_div").length == 0){
		$.showLoading('正在处理中');
		$.ajaxSetup({cache: true});
		$.getScript(BASE+"themes/jqweui/accounting/feedback.js?"+version, function(){
			$.hideLoading();
			showFeedBack();
			$("#feedback_div").popup();
		});
	}else{
		$("#feedback_div").popup();
	}
}
function toUpgradeDiv(){
	if ($("#upgrade_div").length == 0){
		$.showLoading('正在打开中');
		$.ajaxSetup({cache: true});
		$.getScript(BASE+"themes/jqweui/accounting/upgrade_log.js?"+version , function(){
			$.hideLoading();
			showUpgrade();
			$("#upgrade_div").popup();
		});
	}else{
		$("#upgrade_div").popup();
	}
}
function toRechargeDiv(custid,div){
	$.showLoading('正在打开...');
	var func = arguments[2] ? arguments[2] : null;
	$.ajaxSetup({cache: true});
	$.getScript(BASE+"themes/jqweui/accounting/tips_recharge.js?"+version, function(){
		$.hideLoading();
		var time = new Date().Format("hhmmss");
		showRecharge('',custid,'https://app.accounting.yuyaoit.cn/', div, func);
		$("#recharge_div").popup();
	});
}
function toAccountItemDiv(userid,lendid,incomeid,div){
	var objdiv = '';
	if (div == '#lendingList'){objdiv = '#lending_div'; hideLendingDetail();}else if (div == '#income_div'){objdiv = '#income_div';hideIncomeDetail();}else if (div == '#userDetail'){objdiv = '#userDetail';hideLendingDetail();}	if ($("#accountitem_div").length == 0){
		$.ajaxSetup({cache: true});
		$.getScript(BASE+"themes/jqweui/accounting/account_item.js?"+version, function(){
			showAccountItem(userid,lendid,incomeid,objdiv);
		});
	}else{
		$("#accountitem_div").popup();
	}
}
function toAccountListDiv(userid,lendid,incomeid,div){
	var objdiv = '';
	if (div == '#lendingList'){objdiv = '#lending_div'; hideLendingDetail();}else if (div == '#income_div'){objdiv = '#income_div';hideIncomeDetail();}else if (div == '#userDetail'){objdiv = '#userDetail';hideLendingDetail();}
	if ($("#accountitem_div").length == 0){
		$.ajaxSetup({cache: true});
		$.getScript(BASE+"themes/jqweui/accounting/account_item.js?"+version, function(){
			showAccountList(userid,lendid,incomeid,objdiv);
		});
	}else{
		$("#accountitem_div").popup();
	}
}
function toTipsSmsDiv(){
	if ($("#tipssms_div").length == 0){
		$.showLoading('正在处理中');
		$.ajax({type:"GET",url:"https://app.accounting.yuyaoit.cn/tipsset/config", cache:true,async:false,dataType:'json',success:function(d){
			if (d.code == '1'){$("#setting_div").append(d.msg);}
			$.hideLoading();
		}});
	}
	$("#tipssms_div").popup();
}
function toTipsSmsUsers(){
	if ($("#tipssmsusers_div").length == 0){
		$.showLoading('正在处理中');
		$.ajaxSetup({cache: true});
		$.getScript(BASE+"themes/jqweui/accounting/tips_userlist.js?"+version, function(){
			$.hideLoading();
			showTipsUserList();
			$("#tipssmsusers_div").popup();
		});
	}else{
		$("#tipssmsusers_div").popup();
	}
}
function toLendingDiv(title){
	$("#lending_div").find(".weui-cells__title").eq(0).html((title=='开始新增放贷记录') ? title : title+setSearchDiv());
	$(".weui-tab__bd-item").removeClass("weui-tab__bd-item--active");
	$("#lending_div").addClass("weui-tab__bd-item--active");
	$("#nav_bottom").find(".weui-tabbar__item").removeClass("weui-bar__item--on");
	$("#lending_btn").addClass("weui-bar__item--on");
}
function toLendingList(){
	$.showLoading('正在处理中');
	toLendingDiv('我的放贷记录');
	$("#lendingList").html(setLendData());
	$("#lendingList").show();
	$("#formlending").hide();
	$("#lendingList").find(".weui-cell:first").attr("style","border-top:1px solid #d9d9d9");
	$.hideLoading();
}
$("#lending_div").find(".weui-search-bar__input").die().live("input propertychange", function(){
	var key = $(this).val();
	$("#lendingList").find(".weui-cell_access").hide();
	$("#lendingList").find(".weui-cell_access").next().hide();
	$("#lendingList").find(".weui-cell_access").each(function(){
		if ($(this).find("a").find("span").eq(0).text().indexOf(key) !== -1){$(this).show();$(this).next().show();}
	});
});
$("#income_div").find(".weui-search-bar__input").die().live("input propertychange", function(){
	var key = $(this).val();
	$("#incomeList").find(".weui-cell_access").hide();
	$("#incomeList").find(".weui-cell_access").next().hide();
	$("#incomeList").find(".weui-cell_access").each(function(){
		if ($(this).find(".weui-cell__bd").find("span").eq(0).text().indexOf(key) !== -1){$(this).show();$(this).next().show();}
	});
});
function toLendingHistoryList(){
	$.showLoading('正在处理中');
	toLendingDiv('我的历史放贷记录');
	$("#lendingList").html(setLendData(1));
	$("#lendingList").show();
	$("#formlending").hide();
	$("#lendingList").find(".weui-cell:first").attr("style","border-top:1px solid #d9d9d9");
	$.hideLoading();
}
function getLendCurrentByUser(userid){
	var obj = getLendData();
	if (obj.data.length < 1) return '';
	var str = '';
	var flag = 0;
	var i = 0;
	for (var k in obj.data){
		if (obj.data[k].userid == userid){
			var tips_icon = (obj.data[k].overday > today) ? 'weui-icon-waiting' : (obj.data[k].overday == today) ? 'weui-icon-info-circle' : 'weui-icon-warn';
			str += '<a class="weui-cell weui-cell_access currentLending" style="display:none;" href="javascript:showLendingDetail('+obj.data[k].lendid+', \'current\',\'#userDetail\');">';
			str += '<div class="weui-cell__bd"><p>'+obj.data[k].title+'<span class="weui-badge" style="margin-left: 5px;background-color:#3cc51f;">共'+obj.data[k].stage+'期</span></p></div>';
			str += '<div class="weui-cell__ft"><i class="'+tips_icon+'"></i></div>';
			str += '</a>';
			flag = 1;
			i++;
		}
	}
	if (flag){return '<div class="weui-cells__title">当前放贷记录'+i+'笔<span class="sub-title" data=".currentLending">点击展开</span></div>'+str;}else{return '';}
}
function getLendHistoryByUser(userid){
	var obj = getLendHistoryData();
	if (obj.data.length < 1) return '';
	var str = '';
	var flag = 0;
	var i = 0;
	for (var k in obj.data){
		if (obj.data[k].userid == userid){
			var tips_icon = (obj.data[k].status == '2') ? 'weui-icon-success' : 'weui-icon-info-circle';
			str += '<a class="weui-cell weui-cell_access historyLending" style="display:none;" href="javascript:showLendingDetail('+obj.data[k].lendid+', \'history\',\'#userDetail\');">';
			str += '<div class="weui-cell__bd"><p>'+obj.data[k].title+'<span class="weui-badge" style="margin-left: 5px;background-color:#3cc51f;">共'+obj.data[k].stage+'期</span></p></div>';
			str += '<div class="weui-cell__ft"><i class="'+tips_icon+'"></i></div>';
			str += '</a>';
			flag = 1;
			i++;
		}
	}
	if (flag){return '<div class="weui-cells__title">历史放贷记录'+i+'笔<span class="sub-title" data=".historyLending">点击展开</span></div>'+str;}else{return '';}
}
function toUserAdd(){
	$("#formuser").find(".searchCredit").hide();
	$("#formuser").find("input").val('');
	$("#formuser").find("input[name='act']").val('add');
	$("#userList").hide();
	$("#formuser").show();
	$("#userDetail").hide();
	$("#user_div").find(".weui-cells__title").html('<a href="javascript:toUserList();" class="weui-btn weui-btn_mini weui-btn_default">返回客户列表</a>');
}
function toUserEdit(userid){
	$("#userList").hide();
	$("#userDetail").hide();
	$("#formuser").find("input[name='act']").val('edit');
	$("#formuser").find("input[name='userid']").val(userid);
	$("#formuser").find("input[name='name']").val(user.data[userid].name);
	$("#formuser").find("input[name='phone']").val(user.data[userid].phone);
	$("#formuser").find("input[name='cardno']").val((!!user.data[userid].cardno) ? user.data[userid].cardno : '');
	$("#formuser").find("input[name='phone_bak']").val((!!user.data[userid].phone_bak) ? user.data[userid].phone_bak : '');
	$("#formuser").find("input[name='address']").val((!!user.data[userid].address) ? user.data[userid].address : '');
	$("#formuser").find("input[name='bak']").val((!!user.data[userid].bak) ? user.data[userid].bak : '');
	$("#formuser").find(".searchCredit").show();
	$("#formuser").show();
}
function toUserDel(userid){
	$.confirm("确定要删除这个放贷人信息吗?", "确认删除?", function() {
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/user/del", data:"userid="+userid+"&nolend="+((!userHasLending) ? 1 :0),async:false,dataType:'json',success:function(d){
			if (d.code == '1') {
				delete (user.data[d.msg]);
				$.toast("操作成功", 1000);
				setTimeout("toUserList()",800);
			}
		}});
	}, function() {});
}
function toUserDetail(userid){
	$("#userList").hide();
	$("#formuser").hide();
	var hasCurrent = getLendCurrentByUser(userid);
	var hasHistory = getLendHistoryByUser(userid);
	if ((hasCurrent + hasHistory) != '') userHasLending = true; else userHasLending = false;
	$("#user_div").find(".weui-cells__title").html('<a href="javascript:toUserList();" class="weui-btn weui-btn_mini weui-btn_default">返回客户列表</a>');
	var str = '';
	str += '<div class="weui-cell"><div class="weui-cell__bd"><p>姓名</p></div><div class="weui-cell__ft">'+ user.data[userid].name +'</div></div>';
	str += '<div class="weui-cell"><div class="weui-cell__bd"><p>手机号码</p></div><div class="weui-cell__ft"><a href="tel:'+user.data[userid].phone+'">'+ user.data[userid].phone +'</a></div></div>';
		getTipsSmsData();
	str += '<div class="weui-cell weui-cell_switch">';
	str += '<div class="weui-cell__bd">加入短信提醒名单</div>';
	str += '<div class="weui-cell__ft"><label for="setTipsSmsByDetail" class="weui-switch-cp"><input id="setTipsSmsByDetail" class="setTipsSmsBySwitch weui-switch-cp__input" type="checkbox" value="'+userid+'" '+(($.inArray(userid+"",tipssms.ids) >=0) ? ' checked="checked"' : '')+'><div class="weui-switch-cp__box"></div></label></div></div>';
		str += (!!user.data[userid].phone_bak) ? '<div class="weui-cell"><div class="weui-cell__bd"><p>备用手机</p></div><div class="weui-cell__ft"><a href="tel:'+user.data[userid].phone_bak+'">'+ user.data[userid].phone_bak +'</a></div></div>' : '';
	str += (!!user.data[userid].address) ? '<div class="weui-cell"><div class="weui-cell__bd"><p>家庭住址</p></div><div class="weui-cell__ft">'+ user.data[userid].address +'</div></div>' : '';
	str += (!!user.data[userid].bak) ?'<div class="weui-cell"><div class="weui-cell__bd"><p>备注说明</p></div><div class="weui-cell__ft">'+ user.data[userid].bak +'</div></div>' : '';
	str += hasCurrent;
	str += hasHistory;
	str += '<div class="weui-btn-area">';
	str += '<a class="weui-btn weui-btn_plain-primary" href="javascript:toUserEdit('+userid+')">编辑客户资料</a>';
	str += '<a class="weui-btn weui-btn_plain-primary searchCredit" rel="'+userid+'" href="javascript:;">查阅征信</a>';
	if (!userHasLending) str += '<a class="weui-btn weui-btn_warn" href="javascript:toUserDel('+userid+')">删除客户资料</a>'; else  str += '<a class="weui-btn weui-btn_disabled weui-btn_warn">该客户存在放贷记录，无法直接删除。</a>';
	str += '<a href="javascript:toUserList();" class="weui-btn  weui-btn_default">返回客户列表</a>';
	str += '</div>';
	$("#userDetail").html(str);
	$("#userDetail").show();
}
function quickUserAdd(){$("#user_btn").trigger("click");toUserAdd();}
function quickUserList(){$("#user_btn").trigger("click");}
function quickSetting(){$("#setting_btn").trigger("click");}
function quickCreditSearch(){$.closeModal();}
function quickBussLend(){
	$.ajaxSetup({cache: true});
	$.getScript(BASE+"themes/jqweui/accounting/buss_sever.js?"+version, function(){showSeverProvince();});
}
function editPasswd(){
	$.modal({
	  title: "密码修改",
	  text: '<p>请输入原密码<input type="password" class="weui-input weui-prompt-input" id="passwd_old" value="" /></p><br/><p>请输入新密码<input type="password" class="weui-input weui-prompt-input" id="passwd_new" value="" /></p><br/><p>确认新密码<input type="password" class="weui-input weui-prompt-input" id="passwd_renew" value="" /></p>',
	  buttons: [
		{ text: "取消", className: "default"},
		{ text: "确定", onClick: function(){
			var pwd_old = $("#passwd_old").val();
			var pwd_new = $("#passwd_new").val();
			var pwd_renew = $("#passwd_renew").val();
			if ((pwd_old != '') && (pwd_new != '') && (pwd_renew != '')) {
				$.ajax({type:"POST",url:URL+"/customer/setConfig", data:"key=passwd&pwd_old="+pwd_old+"&pwd_renew="+pwd_renew+"&val="+pwd_new, async:false,dataType:'json',success:function(d){
					if (d.code == '1') {
						$.toast("操作成功", 1000);
					}else{$.alert(d.msg);}
				}});
			}else{
				$.alert('密码框内不允许为空');
			}
		}}
	  ]
	});
}
function editPhone(){
	$.modal({
	  title: "请输入你的手机号:",
	  text: '<input class="weui-input weui-prompt-input" id="_customer_phone" value="'+customer.phone+'" type="tel" maxlength="11">',
	  buttons: [
		{ text: "取消", className: "default"},
		{text: "确定", onClick: function(){
			$.showLoading('正在处理中');
			$.ajax({type:"POST",url:URL+"/customer/setConfig", data:"key=phone&val="+$("#_customer_phone").val(), async:false,dataType:'json',success:function(d){
				$.hideLoading();
				if (d.code == '1') {customer.phone = d.msg;$.toast("操作成功", 1000);$("#cust_phone").html(customer.phone);}else{$.alert(d.msg);}
			}});
		}},
		]
	});
}
function editEmail(){
	$.prompt({
		text: "邮箱用于找回密码，当忘记密码时，可以重置新密码到该邮箱",
		title: "请输入邮箱地址",
		onOK: function(text) {
			$(".weui-mask").remove();
			$(".weui-dialog").remove();
			$.ajax({type:"POST",url:URL+"/customer/setConfig", data:"key=email&val="+text, async:false,dataType:'json',success:function(d){
				if (d.code == '1') {
					customer.email = d.msg;
					$.toast("操作成功", 1000);
					$("#cust_email").html(customer.email);
				}else{$.alert(d.msg);}
			}});
		},
		onCancel: function() {$(".weui-mask").remove();$(".weui-dialog").remove();},
		input: customer.email
	});
}
function editLendRate(){
	$.prompt({
		text: "请输入整数，如设置10%月利率，只输入10即可",
		title: "默认放贷利率",
		onOK: function(text) {
			$(".weui-mask").remove();
			$(".weui-dialog").remove();
			$.ajax({type:"POST",url:URL+"/customer/setConfig", data:"key=lendrate&val="+text, async:false,dataType:'json',success:function(d){
				if (d.code == '1') {
					customer.config.lendrate = d.msg;
					$.toast("操作成功", 1000);
					$("#cfg_lendrate").html(customer.config.lendrate);
				}else{$.alert(d.msg);}
			}});
		},onCancel: function() {
			$(".weui-mask").remove();
			$(".weui-dialog").remove();
		},input: customer.config.lendrate
	});
}
function editIncomeNearly(){
	$.prompt({
		text: "请输入默认的提醒天数，如要提醒在7天以内的收款，只输入7即可",
		title: "默认提醒天数",
		onOK: function(text) {
			$(".weui-mask").remove();
			$(".weui-dialog").remove();
			$.ajax({type:"POST",url:URL+"/customer/setConfig", data:"key=incomenearly&val="+text, async:false,dataType:'json',success:function(d){
				$(".weui-mask").remove();
				$(".weui-dialog").remove();
				if (d.code == '1') {
					customer.config.incomenearly = d.msg;
					incomeNearly.update = 0;
					$.toast("操作成功", 1000);
					$("#cfg_incomenearly").html(customer.config.incomenearly);
				}else{$.alert(d.msg);}
			}});
		},onCancel: function() {
			$(".weui-mask").remove();
			$(".weui-dialog").remove();
		},input: customer.config.incomenearly
	});
}
function logout(){$.confirm("确定要退出当前的登录帐号吗?", "确认退出?", function() {window.location.href="https://app.accounting.yuyaoit.cn/customer/logout";}, function() {});}
function toUserList(){
	getUserData();
	getTipsSmsData();
	var viewData = user.data.concat();
	viewData.sort((a, b) => a.name.localeCompare(b.name));
	var str = '';
	$("#user_div").find(".weui-cells__title").html('<a href="javascript:toUserAdd();" class="weui-btn weui-btn_mini weui-btn_default">添加客户</a>'+setSearchDiv());
	for (var k in viewData){
		str += '<a class="weui-cell weui-cell_access" href="javascript:toUserDetail('+viewData[k].userid+');">';
		str += '<div class="weui-cell__hd"><img src="https://app.accounting.yuyaoit.cn/themes/jqweui/accounting/images/user.png" alt=""></div>';
		str += '<div class="weui-cell__bd"><p>'+viewData[k].name+(($.inArray(viewData[k].userid,tipssms.ids)>=0) && tipssms.open ? '<span class="weui-badge" style="margin-left: 5px;background-color:#3cc51f;">SMS</span>' : '')+'</p></div>';
		str += '<div class="weui-cell__ft">'+viewData[k].phone+'</div>';
		str += '</a>';
	}
	if (str == ''){
		str = '<header class="acc-header"><h1 class="acc-title">暂无客户信息</h1></header><div class="acc-content-padded"><a href="javascript:toUserAdd();" class="weui-btn weui-btn_primary">添加客户</a></div>';
	}
	$("#userList").html(str);
	$("#userList").show();
	$("#formuser").hide();
	$("#userDetail").hide();
}
$("#user_div").find(".weui-search-bar__input").die().live("input propertychange", function(){
	var key = $(this).val();
	$("#userList").find(".weui-cell_access").hide();
	$("#userList").find(".weui-cell_access").each(function(){if ($(this).text().indexOf(key) !== -1) $(this).show();});
});
function setFormCust(){
	$("#customerSelect").select("update",{
		title: "选择借款客户",
		items: setInitUser(),
		onOpen: function(){},
		onChange: function(d) {
			$("#formlending").find("input[name='name']").val(d.titles);
			$("#formlending").find("input[name='phone']").val(d.values);
		},
	});
}
function getBadgeTips(){
	if (!indexBadgeTips.update){
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/income/getIncomeTips/7", async:false,dataType:'json',success:function(d){
			if (d.code == '1'){
				indexBadgeTips = d.msg;
				indexBadgeTips.update = 1;
			}
		}});
	}
	$("#badgetips_nearly").html(indexBadgeTips.nearly);
	$("#badgetips_overdue").html(indexBadgeTips.overdue);
	(indexBadgeTips.nearly > 0) ? $("#badgetips_nearly").show() : $("#badgetips_nearly").hide();
	(indexBadgeTips.overdue > 0) ? $("#badgetips_overdue").show() : $("#badgetips_overdue").hide();
}
function getTipsSmsData(){
	if (tipssms.update == 0){
		$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/tipsset/getData", async:false,dataType:'json',success:function(d){
			if (d.code == '1') {
				tipssms.ids = d.msg;
				tipssms.update = 1;
			}
		}});
	}
	return tipssms;
}
function setTipsSmsData(act, userid){
	$.showLoading('正在处理中');
	$.ajax({type:"POST",url:"https://app.accounting.yuyaoit.cn/tipsset/setTipsStatus", data:"act="+act+"&userid="+userid, async:false,dataType:'json',success:function(d){
		$.hideLoading();
		if (d.code == '1'){
			if (act=='add'){
				tipssms.ids.push(d.msg);
				$.toast("成功加入短信提醒名单", 800);
			}else if (act == 'del'){
				var index = tipssms.ids.indexOf(d.msg);
				if (index >= 0) tipssms.ids.splice(index,1);
				$.toast("撤消成功", 800);
			}
		}
	}});
}
function toCreditDiv(f,obj){
	$.ajaxSetup({cache: true});
	$.getScript(BASE+"themes/jqweui/accounting/credit.js?"+version, function(){showCreditDiv(f,obj);});
}
function toCreditLog(){
	$.ajaxSetup({cache: true});
	$.getScript(BASE+"themes/jqweui/accounting/credit.js?"+version, function(){
		CreditSearchShow();
	});
}
$(".setTipsSmsBySwitch").die().live("click", function(){
	if ($(this).is(":checked")){setTipsSmsData('add',$(this).val());}else{setTipsSmsData('del',$(this).val());}
});
function initLendingForm(){
	hideLendingDetail();
	$("#formlending").find("input[name='name']").val('');
	$("#formlending").find("input[name='phone']").val('');
	toLendingDiv('开始新增放贷记录');
	$("#lendingList").hide();
	$("#formlending").show();
	$("#formlending").find("input[name='rate']").val(customer.config.lendrate);
	setFormCust();
	$("#rate_set").select("update",{
		title: "利息单位设置",
		items: [
			{title: "% (月息)",value: "30"},
			{title: "% (十五日息)",value: "15"},
			{title: "% (十日息)",value: "10"},
			{title: "% (周息)",value: "7"},
			{title: "% (日息)",value: "1"}
		],
		onChange: function(d) {
			$("#rate_set").html(d.titles);
			$("#rate_unit").val(d.values);
			calculationIncomeItem();
		},
	});
	$("#stage_set").select("update",{
		title: "选择分期形式",
		items: [
			{title: "期,1月为1期",value: "30"},
			{title: "期,15天为1期",value: "15"},
			{title: "期,10天为1期",value: "10"},
			{title: "期,1周为1期",value: "7"},
			{title: "期,1天为1期",value: "1"}
		],
		onChange: function(d) {
			var days = $("#formlending").find("input[name='stage']").val()
			if (!!d.values){
				$("#stage_set").html(d.titles);
				$("#stage_unit").val(d.values);
				calculationIncomeItem();
			}
		},
	});
//	$("#beginday").calendar({dateFormat: 'yyyy-mm-dd'});
	calculationIncomeItem();
}
function getMoney(){
	$.getJSON("https://app.accounting.yuyaoit.cn/customer/getMoney", function(d){
		if (!!d.code) $("#customerMoney").html(d.money);
	});
}
function showAccountTotalByLend(lendid, type,objdiv){
	obj = (type == 'history') ? lendhistory.data[lendid] : lend.data[lendid];
	$.ajaxSetup({cache: true});
	$.getScript(BASE+"themes/jqweui/accounting/account_item.js?"+version, function(){showAccountTotal(obj, type,objdiv);});
}
$(".goLending").die().live("click", function(){initLendingForm();});
$("#index_btn").on("click", function(){
	$("#index_div").addClass("weui-tab__bd-item--active");
	$("#credit_div").hide();
	var curtime = Date.parse(new Date())/1000;
	if (curtime>curdaytime){$.showLoading('开始更新当天数据...');document.location.reload();return;}
	$("#borrow_div").remove();getBadgeTips();
	$.toptip('服务商名录已开启，请尽快入驻!', 'error');
});
$("#submitPreview").on("click", function(){
	$.showLoading('正在处理...');
	$("#preview").val(1);
	$.post("https://app.accounting.yuyaoit.cn/lending/add", $('#formlending').find("input,textarea").serialize(),function(d){$.hideLoading();if (d.code == '1'){showLendingDetail(0, 'preview', '#lendingList',d);}else{$.alert(d.msg);}},"json");
});
$("#submitlending").on("click", function(){
	$("#preview").val(0);
	$.confirm("确认要添加这笔放贷记录吗?", "确认放贷?", function() {
		$.showLoading('正在处理...');
		$.post("https://app.accounting.yuyaoit.cn/lending/add", $('#formlending').find("input,textarea").serialize(),function(d){
			$.hideLoading();
			if (d.code == '1'){
				if (!!d.lenddata){
					if (!lend.data) lend.data = new Array();
					lend.data[d.lenddata.lendid] = d.lenddata;
					lend.update=0;
				}
				if (!!d.userdata){
					if (!user.data) user.data = new Array();
					user.data[d.userdata.userid] = d.userdata;
					user.update=0;
				}
				incomeNearly.update = 0;
				incomeOverdue.update = 0;
				indexBadgeTips.update = 0;
				initLendingForm();
				showLendMsg(d.lenddata.lendid);
			}else{
				$.alert(d.msg);
			}
		},"json");
	}, function() {});
});
$("#submituser").on("click", function(){
	$.post("https://app.accounting.yuyaoit.cn/user/act", $('#formuser').find("input").serialize(),function(d){
		if (d.code == '1'){
			if (!user.data) user.data = new Array();
			user.data[d.msg.userid] = d.msg;
			$.toast("操作成功", 1000);
			setTimeout("toUserList()",800);
		}else{
			$.alert(d.msg);
		}
	},"json");
});
$("#user_div").find(".sub-title").die().live("click", function(){
	if ($(this).html() == '点击展开'){
		$("#user_div").find($(this).attr("data")).show(300);
		$(this).html('点击收缩');
	}else{
		$("#user_div").find($(this).attr("data")).hide(300);
		$(this).html('点击展开');
	}
});
 $(document).on("click", "#lending_btn", function() {
	$.actions({
		title: "选择操作",
		onClose: function() {},
		actions: [{text: "新增放贷",className: "color-primary",onClick: function() {initLendingForm();}},
		{text: "查看当前放贷",className: "color-primary",onClick: function(){toLendingList();}},
		{text: "查看历史放贷",className: "color-primary",onClick: function(){toLendingHistoryList();}}]
	});
}).on("click", "#income_btn", function() {
	$.actions({
		title: "选择操作",
		onClose: function() {},
		actions: [{text: "查看近期收款",className: "color-primary",onClick: function() {toIncomeDiv('nearly');}},
		{text: "查看逾期收款",className: "color-warning",onClick: function(){toIncomeDiv('overdue');}}]
	});
}).on("click", ".searchCredit", function() {
	var uid = ($(this).attr("rel") == '0') ? $("#formuser").find("input[name='userid']").val() :  $(this).attr("rel");
	$.actions({
		title: "选择征信操作",
		onClose: function() {},
		actions: [{text: "身份证实名认证查询",className: "color-primary",onClick: function() {toCreditDiv('CardRealNameShow', uid);}},
		{text: "借贷黑名单综合查询",className: "color-warning",onClick: function(){toCreditDiv('LeadingBlackShow',uid);}},
		{text: "银行卡二三四要素校验",className: "color-primary",onClick: function() {toCreditDiv('BankCardShow', uid);}},
/*		{text: "个人电子图像查询",className: "color-primary",onClick: function() {toCreditDiv('PersonPhotoShow', uid);}},*/
		{text: "税务负面信息查询",className: "color-primary",onClick: function() {toCreditDiv('TaxInfoShow', uid);}}]
	});
}).on("click", "#user_btn", function() {$("#credit_div").hide();toUserList();
}).on("click", "#setting_btn", function() {$("#credit_div").hide();});
$("#lending_div").find(".lend_current").die().live("click", function(){
	var lendid = $(this).attr('data');
	showLendingDetail(lendid, 'current','#lendingList');
});
$("#lending_div").find(".lend_history").die().live("click", function(){
	var lendid = $(this).attr('data');
	showLendingDetail(lendid, 'history', '#lendingList');
});
$("#income_div").find(".income_current").die().live("click", function(){
	var ids = $(this).attr('data').split("|");
	showIncomeDetail(ids[0], ids[1], 'current');
});
$("#income_div").find(".income_history").die().live("click", function(){
	var ids = $(this).attr('data').split("|");
	showIncomeDetail(ids[0], ids[1], 'history');
});
function showMsg(){$("#msgPages").popup();}
if (/Android/gi.test(navigator.userAgent)) {
	window.addEventListener('resize', function () {
		if (document.activeElement.tagName == 'INPUT' || document.activeElement.tagName == 'TEXTAREA') {
			window.setTimeout(function () {document.activeElement.scrollIntoViewIfNeeded();}, 0);
		}
	})
}
getBadgeTips();
</script>

</body>
</html>
